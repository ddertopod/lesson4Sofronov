# Шаг 3: Оптимизация размера батча

## Описание

Система подбора оптимального размера батча для ONNX модели на основе метрик производительности, в первую очередь p95 latency per sample.

## Структура

```
step3_batch_optimization/
├── src/
│   ├── __init__.py
│   └── batch_optimizer.py  # Основной класс оптимизатора
├── models/                 # Папка для ONNX модели (копировать из step1)
├── results/               # Результаты оптимизации и графики
├── main.py               # Демонстрационный скрипт
└── pyproject.toml        # Зависимости Poetry
```

## Установка

```bash
poetry install
poetry shell
```

## Подготовка

Скопируйте ONNX модель из step1:
```bash
cp ../step1_onnx_model/models/blip_model.onnx models/
```

## Запуск

```bash
python main.py
```

## Что делает система

1. **Тестирование разных размеров батча** - от 1 до максимального значения
2. **Замер метрик производительности**:
   - P95, P99, среднее время latency (общее и per sample)
   - Throughput (samples/second)
   - Использование памяти
3. **Применение ограничений**:
   - Максимальное использование памяти
   - Целевое значение p95 latency
4. **Поиск оптимального размера** по минимальному p95 latency per sample
5. **Визуализация результатов** - графики зависимостей метрик от размера батча

## Критерии оптимизации

Основной критерий: **минимальный p95 latency per sample**

Дополнительные ограничения:
- Максимальное использование памяти
- Целевое время обработки

## Результаты

- `results/optimization_results.csv` - табличные данные
- `results/batch_optimization.png` - визуализация результатов
- Рекомендуемый размер батча в выводе консоли

## Применение результатов

Полученный оптимальный размер батча можно использовать в:
- FastAPI сервисе из step2
- Системе мониторинга из step4
- Продакшен развертывании модели
